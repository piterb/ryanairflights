name: Release

on:
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read version
        id: pkg
        run: |
          node -e "const pkg=require('./package.json'); console.log('version=' + pkg.version);" >> "$GITHUB_OUTPUT"

      - name: Create tag
        run: |
          TAG="v${{ steps.pkg.outputs.version }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists. Skipping."
            exit 0
          fi
          git tag "$TAG"
          git push origin "$TAG"

      - name: Prepare release notes
        env:
          VERSION: ${{ steps.pkg.outputs.version }}
        run: |
          node -e "
          const fs = require('fs');
          const version = process.env.VERSION;
          const content = fs.readFileSync('CHANGELOG.md', 'utf8');
          const header = '## ' + version;
          const start = content.indexOf(header);
          if (start === -1) {
            console.error('Changelog section not found for version ' + version);
            process.exit(1);
          }
          const rest = content.slice(start + header.length);
          const nextHeader = rest.match(/\\n##\\s/);
          const section = (nextHeader ? rest.slice(0, nextHeader.index) : rest).trim();
          fs.writeFileSync('release-notes.md', section || 'No notes provided.');
          "

      - name: Create GitHub release
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v${{ steps.pkg.outputs.version }}"
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists. Skipping."
            exit 0
          fi
          gh release create "$TAG" --title "$TAG" --notes-file release-notes.md
